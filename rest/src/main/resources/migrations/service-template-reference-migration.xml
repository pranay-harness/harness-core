<mongoChangeLog>
    <changeSet changeId="service-template-reference-migration" author="anubhawsrivastava">
        <script>
            function getValidatedReferenceIds(collection, refIds) {
            var validRefIds = [];
            if (refIds &amp;&amp; refIds.length > 0) {
            refIds.forEach(function(id){
            var obj = collection.findOne({_id:id});
            if (!obj) {
            print("Referenced entity with id: " + id + " doesn't exist in collection:" + collection);
            } else {
            validRefIds.push(id);
            }
            });
            }
            return validRefIds;
            }

            db.serviceTemplates.find().forEach(function(serviceTemplate) {

            var originEntityId = serviceTemplate.service;

            var hostIds = getValidatedReferenceIds(db.applicationHosts, serviceTemplate.hosts);
            var tagIds = getValidatedReferenceIds(db.tags, serviceTemplate.tags);
            var leafTagIds = getValidatedReferenceIds(db.tags, serviceTemplate.leafTags);

            db.serviceTemplates.update({ _id: serviceTemplate._id}, {
            $unset: {
            service :"",
            tags :"",
            hosts :"",
            leafTags : ""
            },
            $set : {
            originEntityId : originEntityId,
            tagIds : tagIds,
            hostIds : hostIds,
            leafTagIds : leafTagIds
            }
            });
            });
        </script>
    </changeSet>
</mongoChangeLog>
