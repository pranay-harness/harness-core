# Create image for ci-addon which will be run as an entrypoint in customer
# container
#
# Build the ci-addon docker image using:
# > bazel build --platforms=@io_bazel_rules_go//go/toolchain:linux_amd64 //product/ci/addon/...
# > mvn clean install -pl 980-java-agent; cp ~/.m2/repository/software/wings/980-java-agent/0.0.1-SNAPSHOT/980-java-agent-0.0.1-SNAPSHOT.jar $(bazel info bazel-bin)/product/ci/addon/java-agent.jar
# > docker build -t harness/ci-addon:<tag> -f product/ci/addon/Dockerfile $(bazel info bazel-bin)/product/ci/addon/


FROM alpine:3.12
# Copy ci-addon binary
COPY linux_amd64_pure_stripped/ci-addon /usr/local/bin/ci-addon-linux-amd64
COPY java-agent.jar /usr/local/bin/
RUN chmod +x /usr/local/bin/ci-addon-linux-amd64
RUN addgroup -S 65534 && adduser -S 65534 -G 65534
RUN chown -R 65534:65534 /usr/local/bin
USER 65534
CMD ["/usr/local/bin/ci-addon-linux-amd64"]
